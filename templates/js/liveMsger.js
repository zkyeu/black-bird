function pullMsg(){if(!LiveMsger.isMsgPushAvailable||this.connConfig.socketFailures){var e=this;this.connConfig.scsUrl&&$.ajax(this.connConfig.scsUrl,{dataType:"json",data:{secsign:this.connConfig.connSign,cur_ver_id:this.msgVer},success:function(s){s&&onMsgReturn.call(e,s)},error:function(){}})}else this.socketWorker.postMessage({cmd:"send",msg:{sig_no:50002,data:{cur_ver_id:this.msgVer}}})}function onMsgReturn(e){e=e||{},e.msg_list=[].concat(e.msg_list||[]),e.msg_list.length&&this.msgVer==e.msg_list[0].pre_ver_id&&(this.msgVer=e.msg_list.slice(-1)[0].cur_ver_id,this.onMsg.apply(this,void 0!==[e.msg_list]?[].concat([e.msg_list]):[])),new Date>this.connConfig.signAvailableTime?(clearTimeout(this.msgPullingTimer),clearTimeout(this.reconnectTimer),connect.call(this)):e.has_more?pullMsg.call(this):(!LiveMsger.isMsgPushAvailable||this.connConfig.socketFailures)&&(clearTimeout(this.msgPullingTimer),this.msgPullingTimer=setTimeout(pullMsg.bind(this),this.connConfig.scsInterval,this))}function connect(){var e=this;$.ajax("http://test48.zuoyebang.cc/im/basic/longconnsign?product=kunpeng",{dataType:"json",data:$.extend({product:"kunpeng",protoVersion:1},this.extraArgsForSign?{extra:JSON.stringify(this.extraArgsForSign)}:null),success:function(s){var n=s.data;s&&!s.errNo&&(n.wssHost||n.wsHost||n.scsUrl)&&($.extend(e.connConfig,n),LiveMsger.isMsgPushAvailable?(e.connConfig.socketProtocol=/^https/i.test(location.protocal)||(e.connConfig.socketFailures+1)%3?"wss":"ws",e.socketWorker&&e.socketWorker.postMessage({cmd:"open",url:[e.connConfig.socketProtocol,"://",e.connConfig[e.connConfig.socketProtocol+"Host"],":",e.connConfig[e.connConfig.socketProtocol+"Port"],"/elive?secsign=",e.connConfig.connSign].join(""),pingInterval:e.connConfig.pingInterval})):pullMsg.call(e))},error:function(){}})}function initSocketWorker(){var e=this;return new Promise(function(s,n){$.ajax("http://test48.zuoyebang.cc/static/fudao/base/socketWorker.js",{xhrFields:{withCredentials:!0},async:!1,success:function(n){e.socketWorker=new Worker(URL.createObjectURL(new Blob([n]))),e.socketWorker.onmessage=function(s){switch(s.data.cmd){case"onOpen":e.connConfig.socketFailures=0,clearTimeout(e.msgPullingTimer);break;case"onMsg":var n=s.data.msg;switch(n.sig_no){case 50001:pullMsg.call(e);break;case 50003:onMsgReturn.call(e,n.data)}break;case"onClose":case"onError":clearTimeout(e.reconnectTimer),e.connConfig.socketFailureTicks.push(new Date),e.connConfig.socketFailureTicks.shift(),e.connConfig.socketFailureTicks[4]-e.connConfig.socketFailureTicks[0]<3e4?(LiveMsger.isMsgPushAvailable=!1,pullMsg.call(e)):++e.connConfig.socketFailures%3==0?(pullMsg.call(e),e.reconnectTimer=setTimeout(function(){connect.call(e)},e.connConfig.checkInterval)):connect.call(e)}},s()},error:function(){n()}})})}function LiveMsger(e){this.productType=/^fudao|im$/i.test(e.productType)?RegExp.$_:"fudao",this.uid=(e.uid||"")+"",this.msgVerStorageKey="liveMsger_msgVer_"+this.productType+(this.uid?"_"+this.uid:""),this.onConnectFail=$.isFunction(e.onConnectFail)?e.onConnectFail:null,this.onMsg=$.isFunction(e.onMsg)?e.onMsg:null,this.extraArgsForSign=e.extraArgsForSign||null,this.msgVer=parseInt(localStorage.getItem(this.msgVerStorageKey))||0,this.connConfig={socketFailures:0,socketFailureTicks:[0,0,0,0,0],socketProtocol:"wss",pingInterval:3e3,checkInterval:5e3,scsInterval:1e4},allLiveMsgers.push(this)}var allLiveMsgers=[],URL=window.URL||window.webkitURL;$(window).on("beforeunload",function(){$.each(allLiveMsgers,function(e,s){s.disconnect()})}),LiveMsger.isMsgPushAvailable=$.isFunction(window.Worker)&&$.isFunction(window.WebSocket)&&$.isFunction(URL)&&$.isFunction(Promise),LiveMsger.prototype={constructor:LiveMsger,connect:function(){clearTimeout(this.reconnectTimer);var e=this;return LiveMsger.isMsgPushAvailable&&!this.socketWorker?initSocketWorker.call(this).then(function(){connect.call(e)})["catch"](function(){}):connect.call(this),this},disconnect:function(){return clearTimeout(this.msgPullingTimer),clearTimeout(this.reconnectTimer),LiveMsger.isMsgPushAvailable&&this.socketWorker&&(this.socketWorker.postMessage({cmd:"close"}),this.socketWorker.terminate(),this.socketWorker=null),localStorage.setItem(this.msgVerStorageKey,this.msgVer),this}};